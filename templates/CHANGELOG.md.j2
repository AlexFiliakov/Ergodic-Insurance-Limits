{#
  Keep a Changelog template for python-semantic-release v9.
  Supports both "init" and "update" changelog modes.

  Maps PSR v9 angular parser LONG_TYPE_NAMES to Keep a Changelog categories:
    "features"                 -> ### Added
    "bug fixes"                -> ### Fixed
    everything else            -> ### Changed
#}{%- macro render_sections(release)
%}{%  set ns = namespace(added=[], changed=[], fixed=[])
%}{%  for type, commits in release["elements"].items()
%}{%    if type == "features"
%}{%      set ns.added = ns.added + commits
%}{%    elif type == "bug fixes"
%}{%      set ns.fixed = ns.fixed + commits
%}{%    else
%}{%      set ns.changed = ns.changed + commits
%}{%    endif
%}{%  endfor
%}{%  if ns.added
%}{{    "\n### Added\n"
}}{%    for commit in ns.added
%}{{    "- %s ([`%s`](%s))\n" | format(commit.descriptions[0], commit.short_hash, commit.hexsha | commit_hash_url)
}}{%    endfor
%}{%  endif
%}{%  if ns.changed
%}{{    "\n### Changed\n"
}}{%    for commit in ns.changed
%}{{    "- %s ([`%s`](%s))\n" | format(commit.descriptions[0], commit.short_hash, commit.hexsha | commit_hash_url)
}}{%    endfor
%}{%  endif
%}{%  if ns.fixed
%}{{    "\n### Fixed\n"
}}{%    for commit in ns.fixed
%}{{    "- %s ([`%s`](%s))\n" | format(commit.descriptions[0], commit.short_hash, commit.hexsha | commit_hash_url)
}}{%    endfor
%}{%  endif
%}{%- endmacro
%}{#
#}{%  if ctx.changelog_mode == "update"
%}{%    set new_version = ctx.history.released.keys() | list | first
%}{%    set new_release = ctx.history.released[new_version]
%}{%    set all_versions = ctx.history.released.keys() | list
%}{%    set prev_content = ctx.prev_changelog_file | read_file
%}{%    set parts = prev_content.split(ctx.changelog_insertion_flag, 1)
%}{%    set prev_top = parts[0] | trim
%}{%    set prev_bottom = parts[1] | trim if parts | length > 1 else ""
%}{%    if prev_top | length > 0
%}{{      "%s\n\n%s\n" | format(prev_top, ctx.changelog_insertion_flag)
}}{%    else
%}{{      "%s\n" | format(ctx.changelog_insertion_flag)
}}{%    endif
%}{{    "\n## [%s] - %s\n" | format(new_version.as_tag() | replace("v", ""), new_release.tagged_date.strftime("%Y-%m-%d"))
}}{{    render_sections(new_release)
}}{%    if all_versions | length > 1
%}{{      "\n[%s]: https://github.com/%s/%s/compare/%s...%s\n" | format(new_version.as_tag() | replace("v", ""), ctx.repo_owner, ctx.repo_name, all_versions[1].as_tag(), new_version.as_tag())
}}{%    else
%}{{      "\n[%s]: https://github.com/%s/%s/releases/tag/%s\n" | format(new_version.as_tag() | replace("v", ""), ctx.repo_owner, ctx.repo_name, new_version.as_tag())
}}{%    endif
%}{%    if prev_bottom | length > 0
%}{{      "\n%s\n" | format(prev_bottom)
}}{%    endif
%}{%  else
%}{{    "# Changelog\n\n"
}}{{    "All notable changes to this project will be documented in this file.\n\n"
}}{{    "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.1.0/),\n"
}}{{    "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).\n\n"
}}{{    "%s\n" | format(ctx.changelog_insertion_flag)
}}{%    for version, release in ctx.history.released.items()
%}{{      "\n## [%s] - %s\n" | format(version.as_tag() | replace("v", ""), release.tagged_date.strftime("%Y-%m-%d"))
}}{{      render_sections(release)
}}{%    endfor
%}{%    set all_versions = ctx.history.released.keys() | list
%}{%    if all_versions | length > 0
%}{{      "\n"
}}{%      for version in all_versions
%}{%        if not loop.last
%}{{          "[%s]: https://github.com/%s/%s/compare/%s...%s\n" | format(version.as_tag() | replace("v", ""), ctx.repo_owner, ctx.repo_name, all_versions[loop.index].as_tag(), version.as_tag())
}}{%        else
%}{{          "[%s]: https://github.com/%s/%s/releases/tag/%s\n" | format(version.as_tag() | replace("v", ""), ctx.repo_owner, ctx.repo_name, version.as_tag())
}}{%        endif
%}{%      endfor
%}{%    endif
%}{%  endif
%}
